// worker.js - Sistema completo para Contraentrega CO

addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request))
  })
  
  // ==================== CONFIGURACI√ìN ====================
  const CONFIG = {
    // L√≠mites geogr√°ficos de Colombia
    colombiaBounds: {
      southwest: [-4.23, -81.85],
      northeast: [13.38, -66.85]
    },
    
    // Precio de la licencia en USD
    licensePrice: 100,
    
    // Endpoint para env√≠o de formularios
    formEndpoint: "https://formspree.io/f/YOUR_FORMSPREE_ID",
    
    // Contacto WhatsApp
    whatsappNumber: "573215340988",
    
    // Coordenadas iniciales del mapa
    initialMapView: {
      lat: 4.5709,
      lng: -74.2973,
      zoom: 6
    }
  }
  
  // ==================== DATOS ====================
  const markersData = [
    {
      name: "BODEGAS DROPSHIPPING",
      latlng: [3.5615, -76.4498],
      url: "https://fz.contraentregaco.com",
      info: "Los precios mas competitivos en importados.",
      type: "principal"
    },
    {
      name: "Hey Fressy",
      latlng: [6.2442, -75.5812],
      url: "https://heyfressy.contraentregaco.com",
      info: "",
      type: "secundario"
    },
    {
      name: "Cali",
      latlng: [3.4516, -76.5320],
      url: "https://fz3.contraentregaco.com",
      info: "Oficina principal en Cali. Recepci√≥n de paquetes hasta las 5pm.",
      type: "principal"
    },
    {
      name: "Montebello sector los tanques",
      latlng: [3.4843, -76.5445],
      url: "https://fz4.contraentregaco.com",
      info: "Punto de recogida en Montebello cerca de los tanques de agua.",
      type: "secundario"
    },
    {
      name: "Montebello sector colegio",
      latlng: [3.4845, -76.5471],
      url: "https://fz5.contraentregaco.com",
      info: "Punto junto al colegio Montebello. Horario escolar.",
      type: "secundario"
    },
    {
      name: "Vereda Campo Alegre sector testigos",
      latlng: [3.4705, -76.5560],
      url: "https://fz6.contraentregaco.com",
      info: "Punto rural en vereda Campo Alegre. Atenci√≥n los mi√©rcoles.",
      type: "rural"
    },
    {
      name: "Cl 60 nte # 3 - 09",
      latlng: [3.4889, -76.5122],
      url: "https://fz7.contraentregaco.com",
      info: "Oficina en el norte de Cali. Amplio horario de atenci√≥n.",
      type: "principal"
    }
  ]
  
  const testimonials = [
    {
      quote: "Desde que me un√≠ a Contraentrega, mi negocio aument√≥ sus ventas un 40%. La visibilidad en el mapa es incre√≠ble.",
      author: "Mar√≠a G.",
      business: "Tienda de artesan√≠as, Cali",
      avatar: "https://randomuser.me/api/portraits/women/32.jpg"
    },
    {
      quote: "La red log√≠stica me ha ahorrado mucho dinero en env√≠os. Adem√°s, gano comisiones por cambiar cripto a efectivo.",
      author: "Carlos R.",
      business: "Caf√© Bitcoin, Medell√≠n",
      avatar: "https://randomuser.me/api/portraits/men/45.jpg"
    },
    {
      quote: "Invert√≠ en la licencia y en 3 meses ya la hab√≠a recuperado con los referidos. La mejor decisi√≥n para mi negocio.",
      author: "Laura M.",
      business: "Tienda de tecnolog√≠a, Bogot√°",
      avatar: "https://randomuser.me/api/portraits/women/68.jpg"
    }
  ]
  
  const galleryImages = [
    "https://images.unsplash.com/photo-1600880292203-757bb62b4baf?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60",
    "https://images.unsplash.com/photo-1556740738-b6a63e27c4df?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60",
    "https://images.unsplash.com/photo-1486401899868-0e435ed85128?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60",
    "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60",
    "https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60",
    "https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
  ]
  
  const faqs = [
    {
      question: "¬øC√≥mo activo mi licencia despu√©s del pago?",
      answer: "Recibir√°s un correo con instrucciones y un enlace de activaci√≥n dentro de las 24 horas posteriores al pago confirmado."
    },
    {
      question: "¬øPuedo transferir mi licencia a otra persona?",
      answer: "No, las licencias son personales e intransferibles. Cada socio debe adquirir su propia licencia."
    },
    {
      question: "¬øQu√© pasa si el precio de Bitcoin cambia durante el pago?",
      answer: "El monto en sats se calcula al momento de generar la orden y se bloquea por 15 minutos. Si no completas el pago en ese tiempo, se generar√° una nueva cotizaci√≥n."
    },
    {
      question: "¬øC√≥mo funcionan las comisiones por referidos?",
      answer: "Por cada persona que se registre con tu c√≥digo, recibir√°s 10,000 sats (equivalente a ~$5 USD) cuando complete su pago."
    },
    {
      question: "¬øHay alg√∫n costo recurrente?",
      answer: "No, la licencia es un pago √∫nico de por vida. Nunca te cobraremos mensualidades o mantenimiento."
    }
  ]
  
  // ==================== FUNCIONES UTILITARIAS ====================
  function generateOrderId() {
    const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ"
    const numbers = "0123456789"
    let result = "CE-"
    
    for (let i = 0; i < 2; i++) {
      result += letters.charAt(Math.floor(Math.random() * letters.length))
    }
    
    for (let i = 0; i < 4; i++) {
      result += numbers.charAt(Math.floor(Math.random() * numbers.length))
    }
    
    return result
  }
  
  function formatDate(date) {
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }
    return date.toLocaleDateString('es-ES', options)
  }
  
  async function getBitcoinPrice() {
    try {
      const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd")
      const data = await response.json()
      return data.bitcoin.usd
    } catch (error) {
      console.error("Error fetching Bitcoin price:", error)
      return 50000 // Valor por defecto si falla la API
    }
  }
  
  // ==================== MANEJADOR DE RUTAS ====================
  async function handleRequest(request) {
    const url = new URL(request.url)
    
    // Ruta principal - Mapa interactivo
    if (url.pathname === '/') {
      return new Response(generateMapHTML(), {
        headers: { 
          'Content-Type': 'text/html; charset=utf-8',
          'Cache-Control': 'public, max-age=3600'
        }
      })
    }
    
    // API de marcadores
    if (url.pathname === '/api/markers') {
      return new Response(JSON.stringify(markersData), {
        headers: { 
          'Content-Type': 'application/json',
          'Cache-Control': 'public, max-age=86400'
        }
      })
    }
    
    // P√°gina de socios
    if (url.pathname === '/socios') {
      const sociosHTML = await generateSociosHTML()
      return new Response(sociosHTML, {
        headers: { 
          'Content-Type': 'text/html; charset=utf-8',
          'Cache-Control': 'public, max-age=3600'
        }
      })
    }
    
    // Preguntas frecuentes
    if (url.pathname === '/preguntas-frecuentes') {
      return new Response(generateFAQHTML(), {
        headers: { 
          'Content-Type': 'text/html; charset=utf-8',
          'Cache-Control': 'public, max-age=3600'
        }
      })
    }
    
    // Env√≠o de formulario
    if (url.pathname === '/submit' && request.method === 'POST') {
      return handleFormSubmission(request)
    }
    
    // Ruta no encontrada
    return new Response('P√°gina no encontrada', { 
      status: 404,
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    })
  }
  
  // ==================== GENERADORES DE HTML ====================
  function generateMapHTML() {
    return `<!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Puntos Contraentrega Colombia</title>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
      <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
      <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
      <style>
          body, html {
              margin: 0;
              padding: 0;
              height: 100%;
              font-family: Arial, sans-serif;
          }
          #map {
              width: 100%;
              height: 100vh;
          }
          #search-box {
              position: fixed;
              top: 20px;
              left: 20px;
              z-index: 1000;
              width: 300px;
              background: white;
              padding: 10px;
              border-radius: 5px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.2);
          }
          #search-input {
              width: 100%;
              padding: 10px 15px;
              border: 2px solid #ddd;
              border-radius: 20px;
              font-size: 14px;
              outline: none;
          }
          #search-results {
              margin-top: 10px;
              max-height: 300px;
              overflow-y: auto;
              display: none;
              background: white;
              border-radius: 5px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          .search-result {
              padding: 10px;
              border-bottom: 1px solid #eee;
              cursor: pointer;
          }
          .search-result:hover {
              background-color: #f5f5f5;
          }
          .search-result h3 {
              margin: 0 0 5px 0;
              font-size: 14px;
              color: #333;
          }
          .search-result p {
              margin: 0;
              font-size: 12px;
              color: #666;
          }
          #controls {
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 1000;
              display: flex;
              flex-direction: column;
              gap: 10px;
          }
          .control-btn {
              width: 40px;
              height: 40px;
              border: none;
              border-radius: 50%;
              background: white;
              box-shadow: 0 2px 5px rgba(0,0,0,0.2);
              cursor: pointer;
              font-size: 18px;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          .zoom-controls {
              display: flex;
              flex-direction: column;
              gap: 5px;
              position: fixed;
              bottom: 20px;
              right: 20px;
              z-index: 1000;
          }
          .zoom-btn {
              width: 40px;
              height: 40px;
              border: none;
              border-radius: 50%;
              background: white;
              box-shadow: 0 2px 5px rgba(0,0,0,0.2);
              cursor: pointer;
              font-size: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          .marker-cluster-small {
              background-color: rgba(110, 204, 57, 0.6);
          }
          .marker-cluster-medium {
              background-color: rgba(240, 194, 12, 0.6);
          }
          .marker-cluster-large {
              background-color: rgba(241, 128, 23, 0.6);
          }
          @media (max-width: 768px) {
              #search-box {
                  width: calc(100% - 40px);
                  top: 10px;
                  left: 10px;
              }
              #controls {
                  top: 70px;
                  right: 10px;
              }
              .zoom-controls {
                  bottom: 10px;
                  right: 10px;
              }
              .leaflet-popup-content {
                  width: 250px !important;
              }
          }
      </style>
  </head>
  <body>
      <div id="map"></div>
      
      <div id="search-box">
          <input type="text" id="search-input" placeholder="Buscar puntos... (nombre, direcci√≥n, horario)">
          <div id="search-results"></div>
      </div>
      
      <div id="controls">
          <button id="locate-btn" class="control-btn" title="Mi ubicaci√≥n">üìç</button>
          <a href="/socios" class="control-btn" title="Ser socio" style="text-decoration: none; color: inherit;">üíº</a>
      </div>
      
      <div class="zoom-controls">
          <button id="zoom-in" class="zoom-btn" title="Acercar">+</button>
          <button id="zoom-out" class="zoom-btn" title="Alejar">‚àí</button>
      </div>
  
      <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
      <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
      
      <script>
          // Variables globales
          let map;
          let markerCluster;
          let allMarkers = [];
          let userLocationMarker;
          let searchTimeout;
          
          // L√≠mites geogr√°ficos de Colombia
          const colombiaBounds = L.latLngBounds(
              L.latLng(${CONFIG.colombiaBounds.southwest[0]}, ${CONFIG.colombiaBounds.southwest[1]}),
              L.latLng(${CONFIG.colombiaBounds.northeast[0]}, ${CONFIG.colombiaBounds.northeast[1]})
          );
  
          // Inicializar mapa
          function initMap() {
              map = L.map('map', {
                  zoomControl: false,
                  maxBounds: colombiaBounds,
                  maxBoundsViscosity: 1.0
              }).setView([${CONFIG.initialMapView.lat}, ${CONFIG.initialMapView.lng}], ${CONFIG.initialMapView.zoom});
              
              // Forzar el mapa a permanecer dentro de Colombia
              map.on('drag', function() {
                  if (!colombiaBounds.contains(map.getCenter())) {
                      map.panInsideBounds(colombiaBounds, { animate: true });
                  }
              });
              
              // Bloquear zoom fuera de los l√≠mites
              map.on('zoomend', function() {
                  if (map.getZoom() < 5) {
                      map.setZoom(5);
                  }
              });
  
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '¬© OpenStreetMap contributors',
                  noWrap: true
              }).addTo(map);
  
              // Inicializar cluster de marcadores
              markerCluster = L.markerClusterGroup();
              map.addLayer(markerCluster);
  
              // Cargar marcadores
              loadMarkers();
              // Configurar buscador
              setupSearch();
              // Configurar controles
              setupControls();
              // Configurar zoom personalizado
              setupZoomControls();
          }
  
          // Configurar controles de zoom personalizados
          function setupZoomControls() {
              document.getElementById('zoom-in').addEventListener('click', () => {
                  if (map.getZoom() < 18) {
                      map.zoomIn();
                  }
              });
              
              document.getElementById('zoom-out').addEventListener('click', () => {
                  if (map.getZoom() > 5) {
                      map.zoomOut();
                  }
              });
          }
  
          // Cargar marcadores
          async function loadMarkers() {
              try {
                  const response = await fetch('/api/markers');
                  const markers = await response.json();
                  
                  markers.forEach(markerData => {
                      // Verificar que las coordenadas est√©n dentro de Colombia
                      if (colombiaBounds.contains(markerData.latlng)) {
                          // Crear icono personalizado seg√∫n el tipo
                          let icon;
                          if (markerData.type === 'principal') {
                              icon = L.divIcon({
                                  className: 'custom-marker',
                                  html: 'üü¢',
                                  iconSize: [30, 30]
                              });
                          } else if (markerData.type === 'rural') {
                              icon = L.divIcon({
                                  className: 'custom-marker',
                                  html: 'üü°',
                                  iconSize: [30, 30]
                              });
                          } else {
                              icon = L.divIcon({
                                  className: 'custom-marker',
                                  html: 'üîµ',
                                  iconSize: [30, 30]
                              });
                          }
                          
                          const marker = L.marker(markerData.latlng, { icon })
                              .bindPopup(\`
                                  <div style="max-width:250px">
                                      <h3 style="margin:0 0 5px 0">\${markerData.name}</h3>
                                      <p style="margin:0 0 10px 0">\${markerData.info}</p>
                                      <a href="\${markerData.url}" target="_blank" style="color:#0066cc">Ver detalles ‚Üí</a>
                                  </div>
                              \`);
                          
                          // Almacenar datos para b√∫squeda
                          marker.searchData = \`\${markerData.name} \${markerData.info} \${markerData.url}\`.toLowerCase();
                          marker.data = markerData;
                          
                          allMarkers.push(marker);
                          markerCluster.addLayer(marker);
                      }
                  });
                  
              } catch (error) {
                  console.error('Error cargando marcadores:', error);
              }
          }
  
          // Configurar buscador
          function setupSearch() {
              const searchInput = document.getElementById('search-input');
              const searchResults = document.getElementById('search-results');
              
              searchInput.addEventListener('input', function() {
                  clearTimeout(searchTimeout);
                  searchTimeout = setTimeout(() => {
                      const query = this.value.trim().toLowerCase();
                      
                      if (query.length === 0) {
                          searchResults.style.display = 'none';
                          resetMarkers();
                          return;
                      }
                      
                      const results = allMarkers.filter(marker => 
                          marker.searchData.includes(query)
                      );
                      
                      displaySearchResults(results);
                      updateVisibleMarkers(results);
                      
                  }, 300);
              });
              
              // Cerrar resultados al hacer clic fuera
              document.addEventListener('click', function(e) {
                  if (!e.target.closest('#search-box') && 
                      !e.target.closest('.zoom-controls') && 
                      e.target.id !== 'zoom-in' && 
                      e.target.id !== 'zoom-out') {
                      searchResults.style.display = 'none';
                  }
              });
          }
  
          // Mostrar resultados de b√∫squeda
          function displaySearchResults(results) {
              const searchResults = document.getElementById('search-results');
              searchResults.innerHTML = '';
              
              if (results.length === 0) {
                  searchResults.innerHTML = '<div class="search-result">No se encontraron resultados</div>';
              } else {
                  results.forEach(marker => {
                      const resultItem = document.createElement('div');
                      resultItem.className = 'search-result';
                      resultItem.innerHTML = \`
                          <h3>\${marker.data.name}</h3>
                          <p>\${marker.data.info.substring(0, 60)}\${marker.data.info.length > 60 ? '...' : ''}</p>
                      \`;
                      
                      resultItem.addEventListener('click', () => {
                          map.setView(marker.getLatLng(), 15);
                          marker.openPopup();
                          searchResults.style.display = 'none';
                      });
                      
                      searchResults.appendChild(resultItem);
                  });
              }
              
              searchResults.style.display = 'block';
          }
  
          // Actualizar marcadores visibles
          function updateVisibleMarkers(results) {
              markerCluster.clearLayers();
              
              if (results.length > 0) {
                  markerCluster.addLayers(results);
                  
                  // Ajustar vista para mostrar resultados
                  if (results.length === 1) {
                      map.setView(results[0].getLatLng(), 15);
                  } else {
                      const group = new L.featureGroup(results);
                      map.fitBounds(group.getBounds().pad(0.1));
                  }
              }
          }
  
          // Restablecer todos los marcadores
          function resetMarkers() {
              markerCluster.clearLayers();
              markerCluster.addLayers(allMarkers);
              map.setView([${CONFIG.initialMapView.lat}, ${CONFIG.initialMapView.lng}], ${CONFIG.initialMapView.zoom});
          }
  
          // Configurar controles
          function setupControls() {
              // Bot√≥n de geolocalizaci√≥n
              document.getElementById('locate-btn').addEventListener('click', locateUser);
          }
  
          // Geolocalizaci√≥n del usuario (solo si est√° dentro de Colombia)
          function locateUser() {
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(
                      position => {
                          const userLatLng = [position.coords.latitude, position.coords.longitude];
                          
                          // Verificar si la ubicaci√≥n est√° dentro de Colombia
                          if (!colombiaBounds.contains(userLatLng)) {
                              alert('Tu ubicaci√≥n actual est√° fuera de Colombia');
                              return;
                          }
                          
                          // Eliminar marcador anterior si existe
                          if (userLocationMarker) {
                              map.removeLayer(userLocationMarker);
                          }
                          
                          // Crear nuevo marcador
                          userLocationMarker = L.marker(userLatLng, {
                              icon: L.divIcon({
                                  className: 'user-location-icon',
                                  html: 'üìç',
                                  iconSize: [30, 30]
                              })
                          }).addTo(map)
                          .bindPopup('<b>Tu ubicaci√≥n</b>')
                          .openPopup();
                          
                          // Centrar mapa en la ubicaci√≥n
                          map.setView(userLatLng, 13);
                      },
                      error => {
                          alert('No se pudo obtener tu ubicaci√≥n: ' + error.message);
                      },
                      {
                          enableHighAccuracy: true,
                          timeout: 10000
                      }
                  );
              } else {
                  alert('La geolocalizaci√≥n no est√° disponible en tu navegador');
              }
          }
  
          // Redimensionar mapa al cambiar tama√±o de ventana
          window.addEventListener('resize', () => {
              map.invalidateSize();
          });
  
          // Inicializar la aplicaci√≥n
          document.addEventListener('DOMContentLoaded', initMap);
      </script>
  </body>
  </html>`
  }
  
  async function generateSociosHTML() {
    const btcPrice = await getBitcoinPrice()
    const satsAmount = Math.round((CONFIG.licensePrice / btcPrice) * 100000000)
    
    return `<!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Licencia de Socio - Contraentrega CO</title>
      <style>
          :root {
              --primary: #f7931a;
              --secondary: #1a1a1a;
              --accent: #ff9500;
              --light: #f8f9fa;
              --dark: #0b0e11;
              --success: #28a745;
              --warning: #ffc107;
          }
          
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
              font-family: 'Segoe UI', system-ui, sans-serif;
          }
          
          body {
              background-color: #f5f5f5;
              color: var(--secondary);
              line-height: 1.6;
          }
          
          .container {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
          }
          
          header {
              background: linear-gradient(135deg, var(--primary), var(--accent));
              color: white;
              padding: 40px 0;
              text-align: center;
              border-radius: 0 0 20px 20px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              margin-bottom: 40px;
          }
          
          .logo {
              font-size: 2.5rem;
              font-weight: 700;
              margin-bottom: 10px;
          }
          
          .tagline {
              font-size: 1.2rem;
              opacity: 0.9;
          }
          
          .benefits-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
              gap: 25px;
              margin: 40px 0;
          }
          
          .benefit-card {
              background: white;
              border-radius: 12px;
              padding: 25px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.05);
              transition: transform 0.3s, box-shadow 0.3s;
          }
          
          .benefit-card:hover {
              transform: translateY(-5px);
              box-shadow: 0 8px 16px rgba(0,0,0,0.1);
          }
          
          .benefit-icon {
              font-size: 2.5rem;
              color: var(--primary);
              margin-bottom: 15px;
          }
          
          .benefit-title {
              font-size: 1.3rem;
              margin-bottom: 10px;
              color: var(--secondary);
          }
          
          .pricing-section {
              background: white;
              border-radius: 12px;
              padding: 40px;
              margin: 40px 0;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              text-align: center;
          }
          
          .price-display {
              font-size: 3rem;
              color: var(--primary);
              font-weight: 700;
              margin: 20px 0;
          }
          
          .price-subtext {
              color: #666;
              margin-bottom: 30px;
          }
          
          .btn {
              display: inline-block;
              background: var(--primary);
              color: white;
              padding: 15px 30px;
              border-radius: 50px;
              text-decoration: none;
              font-weight: 600;
              font-size: 1.1rem;
              transition: all 0.3s;
              border: none;
              cursor: pointer;
              box-shadow: 0 4px 8px rgba(247, 147, 26, 0.3);
          }
          
          .btn:hover {
              background: #e07e00;
              transform: translateY(-2px);
              box-shadow: 0 6px 12px rgba(247, 147, 26, 0.4);
          }
          
          .btn-secondary {
              background: var(--secondary);
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          }
          
          .btn-secondary:hover {
              background: #333;
          }
          
          .modal {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.8);
              z-index: 1000;
              overflow-y: auto;
          }
          
          .modal-content {
              background: white;
              margin: 5% auto;
              padding: 30px;
              border-radius: 12px;
              max-width: 600px;
              width: 90%;
              animation: modalFadeIn 0.3s;
          }
          
          @keyframes modalFadeIn {
              from { opacity: 0; transform: translateY(-20px); }
              to { opacity: 1; transform: translateY(0); }
          }
          
          .close-modal {
              float: right;
              font-size: 1.5rem;
              cursor: pointer;
          }
          
          .form-group {
              margin-bottom: 20px;
          }
          
          .form-group label {
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
          }
          
          .form-group input, .form-group select, .form-group textarea {
              width: 100%;
              padding: 12px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              font-size: 1rem;
          }
          
          .payment-instructions {
              background: #f8f9fa;
              border-left: 4px solid var(--primary);
              padding: 20px;
              margin: 20px 0;
              border-radius: 0 8px 8px 0;
          }
          
          .qr-code {
              text-align: center;
              margin: 20px 0;
          }
          
          .qr-code img {
              max-width: 200px;
              border: 1px solid #eee;
              padding: 10px;
              background: white;
          }
          
          .order-summary {
              background: #f8f9fa;
              padding: 20px;
              border-radius: 8px;
              margin: 20px 0;
          }
          
          .order-detail {
              display: flex;
              justify-content: space-between;
              padding: 10px 0;
              border-bottom: 1px solid #eee;
          }
          
          .testimonials {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
              gap: 20px;
              margin: 40px 0;
          }
          
          .testimonial {
              background: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.05);
          }
          
          .testimonial-author {
              display: flex;
              align-items: center;
              margin-top: 15px;
          }
          
          .author-avatar {
              width: 50px;
              height: 50px;
              border-radius: 50%;
              object-fit: cover;
              margin-right: 15px;
          }
          
          .gallery {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
              gap: 15px;
              margin: 40px 0;
          }
          
          .gallery img {
              width: 100%;
              border-radius: 8px;
              transition: transform 0.3s;
              cursor: pointer;
          }
          
          .gallery img:hover {
              transform: scale(1.03);
          }
          
          .whatsapp-btn {
              display: inline-block;
              background: #25D366;
              color: white;
              padding: 12px 20px;
              border-radius: 50px;
              text-decoration: none;
              font-weight: 600;
              margin-top: 10px;
              transition: all 0.3s;
          }
          
          .whatsapp-btn:hover {
              background: #128C7E;
              transform: translateY(-2px);
          }
          
          .timer {
              font-size: 1.5rem;
              font-weight: 700;
              color: var(--primary);
              text-align: center;
              margin: 20px 0;
          }
          
          .success-message {
              background: #d4edda;
              color: #155724;
              padding: 20px;
              border-radius: 8px;
              margin: 20px 0;
              text-align: center;
              display: none;
          }
          
          .nav-link {
              color: var(--primary);
              text-decoration: none;
              font-weight: 600;
              margin: 0 10px;
          }
          
          @media (max-width: 768px) {
              .benefits-grid {
                  grid-template-columns: 1fr;
              }
              
              .price-display {
                  font-size: 2.5rem;
              }
          }
          
          @keyframes pulse {
              0% { transform: scale(1); }
              50% { transform: scale(1.05); }
              100% { transform: scale(1); }
          }
          
          .pulse {
              animation: pulse 2s infinite;
          }
      </style>
  </head>
  <body>
      <header>
          <div class="container">
              <div class="logo">Contraentrega CO</div>
              <div class="tagline">Licencia de Socio - Un solo pago, beneficios para toda la vida</div>
              <div style="margin-top: 20px;">
                  <a href="/socios" class="nav-link">Inicio</a>
                  <a href="/preguntas-frecuentes" class="nav-link">Preguntas Frecuentes</a>
              </div>
          </div>
      </header>
      
      <div class="container">
          <section>
              <h2>¬øQu√© incluye tu licencia de socio?</h2>
              <p>Al unirte a nuestra comunidad global descentralizada, obtienes acceso inmediato a todos estos beneficios:</p>
              
              <div class="benefits-grid">
                  <div class="benefit-card">
                      <div class="benefit-icon">üìç</div>
                      <h3 class="benefit-title">Ubicaci√≥n en el mapa global</h3>
                      <p>Tu negocio aparecer√° en nuestro mapa interactivo con geolocalizaci√≥n satelital, aumentando tu visibilidad.</p>
                  </div>
                  
                  <div class="benefit-card">
                      <div class="benefit-icon">üõí</div>
                      <h3 class="benefit-title">Tienda virtual integrada</h3>
                      <p>Tu propia p√°gina de comercio electr√≥nico donde podr√°s vender productos y servicios, con pagos en Lightning y efectivo.</p>
                  </div>
                  
                  <div class="benefit-card">
                      <div class="benefit-icon">‚ö°</div>
                      <h3 class="benefit-title">Servicios financieros</h3>
                      <p>Podr√°s ofrecer cambio de cripto/efectivo y ganar comisiones por cada transacci√≥n.</p>
                  </div>
                  
                  <div class="benefit-card">
                      <div class="benefit-icon">üöö</div>
                      <h3 class="benefit-title">Red log√≠stica</h3>
                      <p>Acceso a nuestra red de env√≠os y recepci√≥n de mercanc√≠a entre puntos Contraentrega.</p>
                  </div>
                  
                  <div class="benefit-card">
                      <div class="benefit-icon">üí∏</div>
                      <h3 class="benefit-title">Ingresos residuales</h3>
                      <p>Gana comisiones por cada nuevo socio que invites a la red (programa de referidos).</p>
                  </div>
                  
                  <div class="benefit-card">
                      <div class="benefit-icon">üÜò</div>
                      <h3 class="benefit-title">Soporte prioritario</h3>
                      <p>Acceso directo a nuestro equipo de soporte para resolver cualquier duda t√©cnica.</p>
                  </div>
              </div>
          </section>
          
          <section class="pricing-section pulse">
              <h2>Licencia de Socio Vitalicia</h2>
              <div class="price-display" id="priceInSats">${satsAmount.toLocaleString()} sats</div>
              <p class="price-subtext">Equivalente a $${CONFIG.licensePrice} USD (calculado en tiempo real)</p>
              <button id="openModalBtn" class="btn">Adquirir Licencia</button>
          </section>
          
          <section>
              <h2>Testimonios de Socios</h2>
              <div class="testimonials">
                  ${testimonials.map(testimonial => `
                      <div class="testimonial">
                          <p>"${testimonial.quote}"</p>
                          <div class="testimonial-author">
                              <img src="${testimonial.avatar}" alt="${testimonial.author}" class="author-avatar">
                              <div>
                                  <strong>${testimonial.author}</strong>
                                  <div>${testimonial.business}</div>
                              </div>
                          </div>
                      </div>
                  `).join('')}
              </div>
          </section>
          
          <section>
              <h2>Nuestra Comunidad en Im√°genes</h2>
              <div class="gallery">
                  ${galleryImages.map(img => `
                      <img src="${img}" alt="Punto Contraentrega">
                  `).join('')}
              </div>
          </section>
      </div>
      
      <!-- Modal de Compra -->
      <div id="purchaseModal" class="modal">
          <div class="modal-content">
              <span class="close-modal">&times;</span>
              <h2>Completa tu registro</h2>
              <p>Por favor llena este formulario para generar tu orden de pago.</p>
              
              <form id="licenseForm">
                  <div class="form-group">
                      <label for="fullName">Nombre completo</label>
                      <input type="text" id="fullName" name="fullName" required>
                  </div>
                  
                  <div class="form-group">
                      <label for="email">Correo electr√≥nico</label>
                      <input type="email" id="email" name="email" required>
                  </div>
                  
                  <div class="form-group">
                      <label for="phone">Tel√©fono (WhatsApp)</label>
                      <input type="tel" id="phone" name="phone" required>
                  </div>
                  
                  <div class="form-group">
                      <label for="businessName">Nombre de tu negocio (opcional)</label>
                      <input type="text" id="businessName" name="businessName">
                  </div>
                  
                  <div class="form-group">
                      <label for="location">Ciudad y pa√≠s</label>
                      <input type="text" id="location" name="location" required>
                  </div>
                  
                  <div class="form-group">
                      <label for="referral">C√≥digo de referido (si aplica)</label>
                      <input type="text" id="referral" name="referral">
                  </div>
                  
                  <button type="submit" class="btn">Generar Orden de Pago</button>
              </form>
          </div>
      </div>
      
      <!-- Modal de Pago -->
      <div id="paymentModal" class="modal">
          <div class="modal-content">
              <span class="close-modal">&times;</span>
              <h2>Pago con Lightning Network</h2>
              
              <div class="order-summary">
                  <div class="order-detail">
                      <span>Licencia de Socio</span>
                      <span id="licenseSats">${satsAmount.toLocaleString()} sats</span>
                  </div>
                  <div class="order-detail">
                      <span>ID de Orden</span>
                      <span id="orderId">---</span>
                  </div>
                  <div class="order-detail">
                      <span>Fecha</span>
                      <span id="orderDate">---</span>
                  </div>
              </div>
              
              <div class="payment-instructions">
                  <h3>Instrucciones de pago</h3>
                  <p>1. Escanea el c√≥digo QR con tu billetera Lightning</p>
                  <p>2. O copia la factura Lightning manualmente</p>
                  <p>3. El pago debe completarse en <strong>15 minutos</strong></p>
                  
                  <div class="qr-code">
                      <img id="lightningQR" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=lightning:lnbc${satsAmount}u1p3..." alt="QR de pago">
                  </div>
                  
                  <div class="form-group">
                      <label for="lightningInvoice">Factura Lightning</label>
                      <input type="text" id="lightningInvoice" value="lnbc${satsAmount}u1p3..." readonly>
                      <button onclick="copyInvoice()" class="btn-secondary" style="margin-top: 10px; padding: 10px 15px;">Copiar Factura</button>
                  </div>
                  
                  <div class="timer" id="paymentTimer">15:00</div>
                  
                  <p>Al completar el pago, recibir√°s:</p>
                  <ul>
                      <li>Confirmaci√≥n autom√°tica por email</li>
                      <li>Mensaje de WhatsApp con acceso</li>
                      <li>Instrucciones para activar tu punto</li>
                  </ul>
                  
                  <a href="https://wa.me/${CONFIG.whatsappNumber}?text=Hola%20quiero%20confirmar%20mi%20pago%20de%20licencia" id="whatsappLink" class="whatsapp-btn">¬øProblemas con el pago? Confirma por WhatsApp</a>
              </div>
              
              <div class="success-message" id="successMessage">
                  <h3>¬°Pago confirmado!</h3>
                  <p>Tu licencia de socio est√° siendo activada. Revisa tu correo y WhatsApp para los pr√≥ximos pasos.</p>
                  <p>Bienvenido a la familia Contraentrega CO.</p>
              </div>
          </div>
      </div>
      
      <script>
          // Variables globales
          let currentOrder = {};
          let countdownInterval;
          
          // Elementos del DOM
          const modal = document.getElementById("purchaseModal");
          const paymentModal = document.getElementById("paymentModal");
          const openModalBtn = document.getElementById("openModalBtn");
          const closeModalBtns = document.querySelectorAll(".close-modal");
          const licenseForm = document.getElementById("licenseForm");
          const orderId = document.getElementById("orderId");
          const orderDate = document.getElementById("orderDate");
          const whatsappLink = document.getElementById("whatsappLink");
          const successMessage = document.getElementById("successMessage");
          const paymentTimer = document.getElementById("paymentTimer");
          
          // Generar ID de orden
          function generateOrderId() {
              const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
              const numbers = "0123456789";
              let result = "CE-";
              
              for (let i = 0; i < 2; i++) {
                  result += letters.charAt(Math.floor(Math.random() * letters.length));
              }
              
              for (let i = 0; i < 4; i++) {
                  result += numbers.charAt(Math.floor(Math.random() * numbers.length));
              }
              
              return result;
          }
          
          // Iniciar cuenta regresiva
          function startCountdown(duration, display) {
              let timer = duration, minutes, seconds;
              countdownInterval = setInterval(function () {
                  minutes = parseInt(timer / 60, 10);
                  seconds = parseInt(timer % 60, 10);
                  
                  minutes = minutes < 10 ? "0" + minutes : minutes;
                  seconds = seconds < 10 ? "0" + seconds : seconds;
                  
                  display.textContent = minutes + ":" + seconds;
                  
                  if (--timer < 0) {
                      clearInterval(countdownInterval);
                      alert("El tiempo para realizar el pago ha expirado. Por favor genera una nueva orden.");
                      paymentModal.style.display = "none";
                  }
              }, 1000);
          }
          
          // Copiar factura Lightning
          function copyInvoice() {
              const invoiceInput = document.getElementById("lightningInvoice");
              invoiceInput.select();
              document.execCommand("copy");
              alert("Factura Lightning copiada al portapapeles");
          }
          
          // Enviar datos del formulario
          async function submitForm(data) {
              try {
                  const response = await fetch('/submit', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(data)
                  });
                  
                  return await response.json();
              } catch (error) {
                  console.error('Error:', error);
                  return { success: false, error: error.message };
              }
          }
          
          // Event Listeners
          openModalBtn.addEventListener("click", function() {
              modal.style.display = "block";
          });
          
          closeModalBtns.forEach(btn => {
              btn.addEventListener("click", function() {
                  modal.style.display = "none";
                  paymentModal.style.display = "none";
                  if (countdownInterval) clearInterval(countdownInterval);
              });
          });
          
          window.addEventListener("click", function(event) {
              if (event.target === modal) {
                  modal.style.display = "none";
              }
              
              if (event.target === paymentModal) {
                  paymentModal.style.display = "none";
                  if (countdownInterval) clearInterval(countdownInterval);
              }
          });
          
          licenseForm.addEventListener("submit", async function(e) {
              e.preventDefault();
              
              const orderIdValue = generateOrderId();
              const now = new Date();
              
              currentOrder = {
                  fullName: document.getElementById("fullName").value,
                  email: document.getElementById("email").value,
                  phone: document.getElementById("phone").value,
                  businessName: document.getElementById("businessName").value,
                  location: document.getElementById("location").value,
                  referral: document.getElementById("referral").value,
                  orderId: orderIdValue,
                  date: now
              };
              
              const formSubmitted = await submitForm(currentOrder);
              
              if (formSubmitted && formSubmitted.success) {
                  modal.style.display = "none";
                  paymentModal.style.display = "block";
                  
                  // Actualizar UI con datos de la orden
                  orderId.textContent = currentOrder.orderId;
                  orderDate.textContent = formatDate(currentOrder.date);
                  
                  // Configurar enlace de WhatsApp
                  whatsappLink.href = \`https://wa.me/${CONFIG.whatsappNumber}?text=Hola%20quiero%20confirmar%20mi%20pago%20de%20licencia%20con%20ID%20\${currentOrder.orderId}\`;
                  
                  // Iniciar cuenta regresiva de 15 minutos (900 segundos)
                  startCountdown(900, paymentTimer);
                  
                  // Simular pago exitoso despu√©s de 5 segundos (solo para demo)
                  setTimeout(() => {
                      clearInterval(countdownInterval);
                      successMessage.style.display = "block";
                  }, 5000);
              } else {
                  alert("Hubo un error al procesar tu solicitud. Por favor intenta nuevamente.");
              }
          });
          
          // Funci√≥n para formatear fecha
          function formatDate(date) {
              const options = { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
              };
              return date.toLocaleDateString('es-ES', options);
          }
      </script>
  </body>
  </html>`
  }
  
  function generateFAQHTML() {
    return `<!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Preguntas Frecuentes - Contraentrega CO</title>
      <style>
          body {
              font-family: 'Segoe UI', sans-serif;
              line-height: 1.6;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background-color: #f9f9f9;
          }
          
          h1 {
              color: #f7931a;
              text-align: center;
              margin-bottom: 30px;
          }
          
          .faq-item {
              background: white;
              border-radius: 8px;
              padding: 20px;
              margin-bottom: 15px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .question {
              font-weight: bold;
              color: #333;
              margin-bottom: 10px;
          }
          
          .back-btn {
              display: inline-block;
              margin-top: 20px;
              padding: 10px 15px;
              background: #f7931a;
              color: white;
              text-decoration: none;
              border-radius: 5px;
          }
          
          header {
              background: linear-gradient(135deg, #f7931a, #ff9500);
              color: white;
              padding: 30px 0;
              text-align: center;
              border-radius: 0 0 20px 20px;
          }
          
          .nav-link {
              color: #f7931a;
              text-decoration: none;
              font-weight: 600;
              margin: 0 10px;
          }
      </style>
  </head>
  <body>
      <header>
          <div style="max-width: 1200px; margin: 0 auto;">
              <div style="font-size: 2rem; font-weight: 700;">Contraentrega CO</div>
              <div style="margin-top: 15px;">
                  <a href="/socios" class="nav-link">Inicio</a>
                  <a href="/preguntas-frecuentes" class="nav-link">Preguntas Frecuentes</a>
              </div>
          </div>
      </header>
  
      <h1>Preguntas Frecuentes</h1>
      
      ${faqs.map(faq => `
          <div class="faq-item">
              <div class="question">${faq.question}</div>
              <p>${faq.answer}</p>
          </div>
      `).join('')}
      
      <a href="/socios" class="back-btn">Volver a la p√°gina principal</a>
  </body>
  </html>`
  }
  
  // ==================== MANEJADOR DE FORMULARIOS ====================
  async function handleFormSubmission(request) {
    try {
      const formData = await request.json()
      
      const data = {
        name: formData.fullName,
        email: formData.email,
        phone: formData.phone,
        business: formData.businessName || "No especificado",
        location: formData.location,
        referral: formData.referral || "Ninguno",
        orderId: generateOrderId(),
        date: new Date().toISOString(),
        satsAmount: await calculateSatsAmount()
      }
      
      // Enviar a Formspree
      const response = await fetch(CONFIG.formEndpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(data)
      })
      
      if (response.ok) {
        return new Response(JSON.stringify({
          success: true,
          orderId: data.orderId,
          satsAmount: data.satsAmount
        }), {
          headers: { "Content-Type": "application/json" }
        })
      } else {
        return new Response(JSON.stringify({
          success: false,
          error: "Error al enviar el formulario"
        }), {
          status: 500,
          headers: { "Content-Type": "application/json" }
        })
      }
    } catch (error) {
      return new Response(JSON.stringify({
        success: false,
        error: error.message
      }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      })
    }
  }
  
  async function calculateSatsAmount() {
    const btcPrice = await getBitcoinPrice()
    return Math.round((CONFIG.licensePrice / btcPrice) * 100000000)
  }